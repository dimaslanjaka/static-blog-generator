name: Dev Build

on:
  push:
    branches: [ dev ]

# cancel previous workflows, run only one workflow
#concurrency:
#  group: build-${{ github.event.push.number || github.event.pull_request.number || github.ref }}
#  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: szenius/set-timezone@v1.0
      with:
        timezoneLinux: "Asia/Jakarta"
        timezoneMacos: "Asia/Jakarta"
        timezoneWindows: "Western Indonesia Time"
    - uses: actions/checkout@v3
      with:
        submodules: recursive
        token: "${{ secrets.GITHUB_TOKEN }}"
        ref: "dev"
    - uses: actions/setup-node@v3
      with:
        node-version: '16'

    # https://stackoverflow.com/a/61699863/6404439
    # ${{ steps.vars.outputs.branch }}
    # ${{ steps.vars.outputs.hash }}
    - name: Declare some variables
      id: vars
      shell: bash
      run: |
        echo "##[set-output name=branch;]$(echo ${GITHUB_REF#refs/heads/})"
        echo "::set-output name=hash::$(git rev-parse --short HEAD)"
        echo "::set-output name=yarn::$(yarn cache dir)"
        echo "::set-output name=npm::$(npm config get cache)"

    - uses: actions/cache@v3
      with:
        path: |
          ${{ steps.vars.outputs.npm }}
          ./tmp
          ./node_modules
        key: ${{ runner.os }}-${{ hashFiles('.guid') }}

    - name: Resolve git user
      continue-on-error: true
      run: |
        cdir="$PWD"
        git checkout dev
        git config user.email "dimaslanjaka@gmail.com"
        git config user.name "dimaslanjaka"
        git fetch --all
        git pull --all
        git submodule update -i -r
        git submodule foreach git submodule update -i -r

    - run: npm i -g gulp-cli typescript npm ts-node npm yarn
    - run: npm install

    - name: fix module resolutions
      continue-on-error: true
      run: |
        git add package-lock.json
        git commit -m "[${{ steps.vars.outputs.hash }}] update module resolutions"
        git push

    - name: Build
      continue-on-error: true
      run: |
        rm -rf dist/*
        npm run build
        git push

    - name: Packaging
      continue-on-error: true
      run: |
        npm pack
        git add release
        git commit -m "[${{ steps.vars.outputs.hash }}] update release"
        git push

    - name: Test JS
      id: test-js
      working-directory: tests
      run: npm i file:../ && node index.js

    - name: Test TS
      id: test-ts
      working-directory: tests
      run: npm i file:../ && node -r ts-node/register index.ts

    - name: Test mocha
      id: test-mocha
      run: sh bin/mock-data && npm run test:mocha

    - name: Test bin single task
      run: npm i file:../ && npx sbg copy --nocache --verbose
      working-directory: tests
      id: test-bin-single

    - name: Test bin multiple task
      run: npm i file:../ && npx sbg clean copy --nocache --verbose
      working-directory: tests
      id: test-bin-multiple

    - name: Commit & Push
      continue-on-error: true
      run: |
        git pull
        git add dist release
        git commit -m "build from @https://github.com/dimaslanjaka/static-blog-generator/commit/${{ steps.vars.outputs.hash }}"
        git push

#    - name: Re-deploy ðŸš€
#      uses: JamesIves/github-pages-deploy-action@v4.3.0
#      with:
#        branch: main # The branch the action should deploy to.
#        folder: . # The folder the action should deploy.
#        force: false # merge instead delete old files
#        token: "${{ secrets.GITHUB_TOKEN }}"
